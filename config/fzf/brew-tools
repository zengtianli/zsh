### UNIFIED BREW TOOLS
# ç»Ÿä¸€çš„HomebrewåŒ…ç®¡ç†å·¥å…·
# é›†æˆå®‰è£…ã€æ›´æ–°ã€æ¸…ç†åŠŸèƒ½

# å®šä¹‰ç°ä»£å·¥å…·åˆ—è¡¨ï¼ˆç”¨äºæ¨èå’Œå®‰å…¨æ£€æŸ¥ï¼‰
local modern_tools="eza bat fd dust duf procs btop sd git-delta dog gping httpie yq jc just hyperfine croc age miller visidata nmap ripgrep git zsh tmux nvim fzf"

# ä¸»èœå•
local action=$(echo "ğŸ“¦ å®‰è£…åŒ… (Install Packages)
ğŸ”„ æ›´æ–°åŒ… (Update Packages)  
ğŸ—‘ï¸ æ¸…ç†åŒ… (Clean Packages)
ğŸ“Š æŸ¥çœ‹çŠ¶æ€ (Show Status)" | fzf --header='[ğŸº Homebrewå·¥å…·ç®±] é€‰æ‹©æ“ä½œ' --height=60%)

case $action in
  *"å®‰è£…åŒ…"*)
    echo "ğŸš€ === åŒ…å®‰è£…æ¨¡å¼ ==="
    
    # åˆ›å»ºå¸¦åˆ†ç±»çš„æœç´¢åˆ—è¡¨
    local search_list=$(
      echo "=== ğŸš€ æ¨èç°ä»£å·¥å…· ==="
      for tool in $(echo $modern_tools); do
        # æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
        if command -v "$tool" &> /dev/null; then
          echo "âœ… $tool (å·²å®‰è£…)"
        else
          echo "ğŸ“¦ $tool"
        fi
      done
      echo ""
      echo "=== ğŸ” æœç´¢æ‰€æœ‰åŒ… ==="
      brew search ""
    )

    local inst=$(echo "$search_list" | fzf -m --header='[ğŸ“¦ é€‰æ‹©è¦å®‰è£…çš„åŒ…] Tab:å¤šé€‰ Enter:ç¡®è®¤' | grep -E '^ğŸ“¦|^[^=âœ…]' | sed 's/^ğŸ“¦ //' | sed 's/^âœ… .*//')

    if [[ $inst ]]; then
      echo "ğŸš€ å‡†å¤‡å®‰è£…ä»¥ä¸‹åŒ…ï¼š"
      echo "$inst" | tr ' ' '\n'
      echo ""
      echo -n "â“ ç¡®è®¤å®‰è£…? [y/N]: "
      read -r confirm
      if [[ "$confirm" =~ ^[Yy]$ ]]; then
        for prog in $(echo $inst); do 
          echo "ğŸ“¦ å®‰è£… $prog..."
          brew install $prog
        done
        echo "âœ… å®‰è£…å®Œæˆï¼è¿è¡Œ check_modern_tools æ£€æŸ¥ç°ä»£å·¥å…·çŠ¶æ€"
      else
        echo "âŒ å®‰è£…å·²å–æ¶ˆ"
      fi
    fi
    ;;

  *"æ›´æ–°åŒ…"*)
    echo "ğŸ”„ === åŒ…æ›´æ–°æ¨¡å¼ ==="
    
    # æ£€æŸ¥è¿‡æ—¶çš„åŒ…
    local outdated=$(brew outdated --quiet)

    if [[ -z "$outdated" ]]; then
      echo "âœ… æ‰€æœ‰åŒ…éƒ½æ˜¯æœ€æ–°çš„ï¼"
      return 0
    fi

    echo "ğŸ“¦ å‘ç°ä»¥ä¸‹è¿‡æ—¶çš„åŒ…ï¼š"
    echo "$outdated"
    echo ""

    # ä½¿ç”¨FZFé€‰æ‹©è¦æ›´æ–°çš„åŒ…
    local upd=$(echo "$outdated" | fzf -m --header='[ğŸ”„ é€‰æ‹©è¦æ›´æ–°çš„åŒ…] Tab:å¤šé€‰ Enter:ç¡®è®¤')

    if [[ $upd ]]; then
      echo "ğŸš€ å‡†å¤‡æ›´æ–°ä»¥ä¸‹åŒ…ï¼š"
      echo "$upd" | tr ' ' '\n'
      echo ""
      echo -n "â“ ç¡®è®¤æ›´æ–°? [y/N]: "
      read -r confirm
      if [[ "$confirm" =~ ^[Yy]$ ]]; then
        for prog in $(echo $upd); do 
          echo "ğŸ”„ æ›´æ–° $prog..."
          brew upgrade $prog
        done
        echo "âœ… æ›´æ–°å®Œæˆï¼"
        
        # å¦‚æœæ›´æ–°äº†ç°ä»£å·¥å…·ï¼Œæç¤ºæ£€æŸ¥çŠ¶æ€
        if echo "$upd" | grep -qE "(eza|bat|fd|dust|duf|procs|btop|sd|delta|dog|gping|httpie|yq|jc|just|hyperfine|croc|age)"; then
          echo "ğŸ’¡ è¿è¡Œ check_modern_tools æ£€æŸ¥ç°ä»£å·¥å…·çŠ¶æ€"
        fi
      else
        echo "âŒ æ›´æ–°å·²å–æ¶ˆ"
      fi
    fi
    ;;

  *"æ¸…ç†åŒ…"*)
    echo "ğŸ—‘ï¸ === åŒ…æ¸…ç†æ¨¡å¼ ==="
    
    # è·å–å¯å¸è½½çš„åŒ…ï¼ˆå¶å­èŠ‚ç‚¹ï¼‰
    local leaves=$(brew leaves)

    if [[ -z "$leaves" ]]; then
      echo "âœ… æ²¡æœ‰å¯æ¸…ç†çš„åŒ…ï¼"
      return 0
    fi

    # ä¸ºé‡è¦å·¥å…·æ·»åŠ è­¦å‘Šæ ‡è®°
    local marked_list=$(
      echo "$leaves" | while read -r package; do
        if echo "$modern_tools" | grep -qw "$package"; then
          echo "âš ï¸  $package (é‡è¦å·¥å…·)"
        else
          echo "ğŸ“¦ $package"
        fi
      done
    )

    local uninst=$(echo "$marked_list" | fzf -m --header='[ğŸ—‘ï¸ é€‰æ‹©è¦å¸è½½çš„åŒ…] âš ï¸=é‡è¦å·¥å…· Tab:å¤šé€‰' | sed 's/^[âš ï¸ğŸ“¦]* *//')

    if [[ $uninst ]]; then
      echo "ğŸ—‘ï¸ å‡†å¤‡å¸è½½ä»¥ä¸‹åŒ…ï¼š"
      echo "$uninst" | tr ' ' '\n'
      echo ""
      
      # æ£€æŸ¥æ˜¯å¦åŒ…å«é‡è¦å·¥å…·
      local has_important=false
      for pkg in $(echo "$uninst"); do
        if echo "$modern_tools" | grep -qw "$pkg"; then
          echo "âš ï¸  è­¦å‘Š: $pkg æ˜¯é‡è¦çš„ç°ä»£å·¥å…·ï¼"
          has_important=true
        fi
      done
      
      if [[ "$has_important" == "true" ]]; then
        echo ""
        echo "â— ä½ æ­£è¦å¸è½½é‡è¦å·¥å…·ï¼Œè¿™å¯èƒ½å½±å“ç°ä»£åŒ–é…ç½®ï¼"
      fi
      
      echo -n "â“ ç¡®è®¤å¸è½½? [y/N]: "
      read -r confirm
      if [[ "$confirm" =~ ^[Yy]$ ]]; then
        for prog in $(echo $uninst); do 
          echo "ğŸ—‘ï¸ å¸è½½ $prog..."
          brew uninstall $prog
        done
        echo "âœ… æ¸…ç†å®Œæˆï¼"
        echo "ğŸ’¡ è¿è¡Œ check_modern_tools æ£€æŸ¥ç°ä»£å·¥å…·çŠ¶æ€"
      else
        echo "âŒ æ¸…ç†å·²å–æ¶ˆ"
      fi
    fi
    ;;

  *"æŸ¥çœ‹çŠ¶æ€"*)
    echo "ğŸ“Š === HomebrewçŠ¶æ€ ==="
    echo ""
    echo "ğŸº Homebrewç‰ˆæœ¬:"
    brew --version
    echo ""
    echo "ğŸ“¦ å·²å®‰è£…åŒ…æ•°é‡:"
    brew list | wc -l | awk '{print $1 " ä¸ªåŒ…"}'
    echo ""
    echo "ğŸ”„ è¿‡æ—¶åŒ…æ£€æŸ¥:"
    local outdated_count=$(brew outdated --quiet | wc -l)
    if [[ $outdated_count -eq 0 ]]; then
      echo "âœ… æ‰€æœ‰åŒ…éƒ½æ˜¯æœ€æ–°çš„"
    else
      echo "âš ï¸  æœ‰ $outdated_count ä¸ªåŒ…éœ€è¦æ›´æ–°"
      brew outdated --quiet | head -5
      [[ $outdated_count -gt 5 ]] && echo "... è¿˜æœ‰ $((outdated_count - 5)) ä¸ªåŒ…"
    fi
    echo ""
    echo "ğŸ§¹ å¯æ¸…ç†åŒ…:"
    local leaves_count=$(brew leaves | wc -l)
    echo "ğŸ“¦ $leaves_count ä¸ªå¶å­åŒ…å¯ä»¥æ¸…ç†"
    echo ""
    echo "ğŸ’¡ è¿è¡Œ check_modern_tools æ£€æŸ¥ç°ä»£å·¥å…·çŠ¶æ€"
    ;;
esac 