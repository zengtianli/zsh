### UNIFIED PROCESS TOOLS
# ç»Ÿä¸€çš„è¿›ç¨‹ç®¡ç†å·¥å…·
# é›†æˆè¿›ç¨‹æŸ¥çœ‹ã€ç»ˆæ­¢ã€ç›‘æ§åŠŸèƒ½

# ä¸»èœå•
local action=$(echo "âš¡ ç»ˆæ­¢è¿›ç¨‹ (Kill Process)
ğŸ‘€ æŸ¥çœ‹è¿›ç¨‹ (View Processes)
ğŸ“Š è¿›ç¨‹ç›‘æ§ (Process Monitor)
ğŸ” æœç´¢è¿›ç¨‹ (Search Process)" | fzf --header='[âš¡ è¿›ç¨‹ç®¡ç†å·¥å…·ç®±] é€‰æ‹©æ“ä½œ' --height=60%)

case $action in
  *"ç»ˆæ­¢è¿›ç¨‹"*)
    echo "âš¡ === è¿›ç¨‹ç»ˆæ­¢æ¨¡å¼ ==="
    
    # æ£€æŸ¥æ˜¯å¦å®‰è£…äº†procs
    if command -v procs &> /dev/null; then
      echo "ğŸš€ ä½¿ç”¨ç°ä»£åŒ–è¿›ç¨‹ç®¡ç†å·¥å…·(procs)..."
      echo "ğŸ” é€‰æ‹©è¦ç®¡ç†çš„è¿›ç¨‹ (Tab: å¤šé€‰, Enter: ç»ˆæ­¢, Ctrl-C: å–æ¶ˆ)"
      
      local pids=$(procs --color always | fzf -m \
        --header='[âš¡ è¿›ç¨‹ç®¡ç†] Tab:å¤šé€‰ Enter:ç»ˆæ­¢é€‰ä¸­è¿›ç¨‹' \
        --preview 'echo "è¿›ç¨‹è¯¦æƒ…:" && echo {} | awk "{print \"PID: \" \$1 \"\nCMD: \" \$NF \"\nCPU: \" \$(NF-3) \"\nMEM: \" \$(NF-2)}"' \
        --preview-window right:40% \
        | awk 'NR>1 {print $1}')
      
      if [[ -n "$pids" ]]; then
        echo "ğŸ¯ é€‰ä¸­çš„PID: $(echo $pids | tr '\n' ' ')"
        echo -n "â“ ç¡®è®¤ç»ˆæ­¢è¿™äº›è¿›ç¨‹? [y/N]: "
        read -r confirm
        if [[ "$confirm" =~ ^[Yy]$ ]]; then
          echo "$pids" | xargs -I{} kill -15 {}
          echo "âœ… å·²å‘é€ç»ˆæ­¢ä¿¡å·åˆ°é€‰ä¸­è¿›ç¨‹"
        else
          echo "âŒ æ“ä½œå·²å–æ¶ˆ"
        fi
      fi
    else
      echo "ğŸ”§ ä½¿ç”¨ä¼ ç»Ÿæ¨¡å¼ (å¯è¿è¡Œ brew-tools å®‰è£… procs è·å¾—æ›´ä½³ä½“éªŒ)"
      
      local pid=$(ps -ef | sed 1d | fzf -m --header='[âš¡ è¿›ç¨‹ç®¡ç† - ä¼ ç»Ÿæ¨¡å¼] Tab:å¤šé€‰ Enter:ç»ˆæ­¢' | awk '{print $2}')

      if [ "x$pid" != "x" ]; then
        echo "ğŸ¯ é€‰ä¸­çš„PID: $(echo $pid | tr '\n' ' ')"
        echo -n "â“ ç¡®è®¤ç»ˆæ­¢è¿›ç¨‹? [y/N]: "
        read -r confirm
        if [[ "$confirm" =~ ^[Yy]$ ]]; then
          echo $pid | xargs kill -15
          echo "âœ… å·²å‘é€ç»ˆæ­¢ä¿¡å·"
        else
          echo "âŒ æ“ä½œå·²å–æ¶ˆ"
        fi
      fi
    fi
    ;;

  *"æŸ¥çœ‹è¿›ç¨‹"*)
    echo "ğŸ‘€ === è¿›ç¨‹æŸ¥çœ‹æ¨¡å¼ ==="
    
    if command -v procs &> /dev/null; then
      echo "ğŸš€ ä½¿ç”¨procsæŸ¥çœ‹è¿›ç¨‹åˆ—è¡¨..."
      local sort_option=$(echo "CPUä½¿ç”¨ç‡ (cpu)
å†…å­˜ä½¿ç”¨ (memory)  
è¿›ç¨‹ID (pid)
ç”¨æˆ· (user)
å‘½ä»¤ (command)" | fzf --header='[ğŸ“Š é€‰æ‹©æ’åºæ–¹å¼]' | awk '{print $NF}' | tr -d '()')
      
      if [[ -n "$sort_option" ]]; then
        echo "ğŸ“Š æŒ‰ $sort_option æ’åºçš„è¿›ç¨‹åˆ—è¡¨:"
        case $sort_option in
          cpu) procs --sortd cpu ;;
          memory) procs --sortd memory ;;
          pid) procs --sortd pid ;;
          user) procs --sortd user ;;
          command) procs --sortd command ;;
          *) procs ;;
        esac
      else
        procs
      fi
    else
      echo "ğŸ”§ ä½¿ç”¨ä¼ ç»Ÿpså‘½ä»¤..."
      ps aux | head -20
      echo ""
      echo "ğŸ’¡ å®‰è£…procsè·å¾—æ›´å¥½ä½“éªŒ: brew-tools"
    fi
    ;;

  *"è¿›ç¨‹ç›‘æ§"*)
    echo "ğŸ“Š === è¿›ç¨‹ç›‘æ§æ¨¡å¼ ==="
    
    if command -v btop &> /dev/null; then
      echo "ğŸš€ å¯åŠ¨btopç°ä»£ç³»ç»Ÿç›‘æ§..."
      btop
    elif command -v top &> /dev/null; then
      echo "ğŸ”§ å¯åŠ¨ä¼ ç»Ÿtopç›‘æ§..."
      top
    else
      echo "âŒ æœªæ‰¾åˆ°ç³»ç»Ÿç›‘æ§å·¥å…·"
      echo "ğŸ’¡ å®‰è£…btopè·å¾—ç°ä»£ç›‘æ§ä½“éªŒ: brew-tools"
    fi
    ;;

  *"æœç´¢è¿›ç¨‹"*)
    echo "ğŸ” === è¿›ç¨‹æœç´¢æ¨¡å¼ ==="
    
    echo -n "ğŸ” è¾“å…¥è¦æœç´¢çš„è¿›ç¨‹åç§°æˆ–å…³é”®è¯: "
    read -r search_term
    
    if [[ -z "$search_term" ]]; then
      echo "âŒ æœç´¢è¯ä¸èƒ½ä¸ºç©º"
      return 1
    fi
    
    if command -v procs &> /dev/null; then
      echo "ğŸš€ ä½¿ç”¨procsæœç´¢è¿›ç¨‹..."
      local found_procs=$(procs | grep -i "$search_term")
      if [[ -n "$found_procs" ]]; then
        echo "âœ… æ‰¾åˆ°åŒ¹é…çš„è¿›ç¨‹:"
        echo "$found_procs"
        echo ""
        echo -n "â“ æ˜¯å¦è¦ç»ˆæ­¢æŸä¸ªè¿›ç¨‹? [y/N]: "
        read -r kill_confirm
        if [[ "$kill_confirm" =~ ^[Yy]$ ]]; then
          local kill_pid=$(echo "$found_procs" | fzf --header='[é€‰æ‹©è¦ç»ˆæ­¢çš„è¿›ç¨‹]' | awk '{print $1}')
          if [[ -n "$kill_pid" ]]; then
            echo -n "â“ ç¡®è®¤ç»ˆæ­¢è¿›ç¨‹ $kill_pid? [y/N]: "
            read -r final_confirm
            if [[ "$final_confirm" =~ ^[Yy]$ ]]; then
              kill -15 "$kill_pid"
              echo "âœ… å·²å‘é€ç»ˆæ­¢ä¿¡å·åˆ°è¿›ç¨‹ $kill_pid"
            fi
          fi
        fi
      else
        echo "âŒ æœªæ‰¾åˆ°åŒ¹é…çš„è¿›ç¨‹: $search_term"
      fi
    else
      echo "ğŸ”§ ä½¿ç”¨ä¼ ç»Ÿpsæœç´¢..."
      local found_procs=$(ps aux | grep -i "$search_term" | grep -v grep)
      if [[ -n "$found_procs" ]]; then
        echo "âœ… æ‰¾åˆ°åŒ¹é…çš„è¿›ç¨‹:"
        echo "$found_procs"
      else
        echo "âŒ æœªæ‰¾åˆ°åŒ¹é…çš„è¿›ç¨‹: $search_term"
      fi
    fi
    ;;
esac 